---
import { getHolidays, getExtendedWeekends } from '../utils/holidayUtils.js';
import { getMonthName, getWeekdayName, getMonthStartDay, getDaysInMonth, getCurrentYear } from '../utils/dateUtils.js';

const { year = getCurrentYear() } = Astro.props;

const holidays = getHolidays(year);
const { extendedWeekends, extraExtendedWeekends } = getExtendedWeekends(year);

const months = Array.from({ length: 12 }, (_, i) => {
  const date = new Date(Date.UTC(year, i, 1));
  const startDay = getMonthStartDay(year, i);
  return {
    name: getMonthName(date),
    days: getDaysInMonth(year, i),
    startDay: startDay,
  };
});

const weekdays = Array.from({ length: 7 }, (_, i) => getWeekdayName(i));

function getDayClass(year, month, day) {
  const date = new Date(Date.UTC(year, month, day));
  const dateString = date.toLocaleString('lt-LT', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Europe/Vilnius' });
  const dayOfWeek = date.getUTCDay();
  const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
  const isHoliday = holidays.some(h => h.date === dateString);
  const isExtendedWeekend = extendedWeekends.includes(dateString);
  const isExtraExtendedWeekend = extraExtendedWeekends.includes(dateString);

  let classes = 'relative p-1 h-16 md:h-20 border border-gray-200 transition-colors duration-200';
  if (isWeekend) classes += ' bg-gray-100 hover:bg-gray-200';
  if (isHoliday) classes += ' bg-red-100 hover:bg-red-200';
  if (isExtendedWeekend) classes += ' bg-green-100 hover:bg-green-200';
  if (isExtraExtendedWeekend) classes += ' bg-blue-100 hover:bg-blue-200';
  return classes;
}

function getDayLabel(year, month, day) {
  const date = new Date(Date.UTC(year, month, day));
  const dateString = date.toLocaleString('lt-LT', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Europe/Vilnius' });
  const holiday = holidays.find(h => h.date === dateString);
  if (holiday) return holiday.name;
  if (extraExtendedWeekends.includes(dateString)) return 'Ypač pratęstas savaitgalis';
  if (extendedWeekends.includes(dateString)) return 'Pratęstas savaitgalis';
  return '';
}
---

<div class="calendar-container">
  <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">{year} Metų Kalendorius</h1>
  <div class="month-grid">
    {months.map((month, monthIndex) => (
      <div class="month-card">
        <div class="month-header">
          <h2 class="text-lg font-semibold text-center">{month.name}</h2>
        </div>
        <div class="weekday-header">
          {weekdays.map((day) => (
            <div class="weekday">{day}</div>
          ))}
        </div>
        <div class="days-grid">
          {Array.from({ length: month.startDay }).map(() => (
            <div class="empty-day"></div>
          ))}
          {Array.from({ length: month.days }).map((_, dayIndex) => {
            const day = dayIndex + 1;
            const dayClass = getDayClass(year, monthIndex, day);
            const dayLabel = getDayLabel(year, monthIndex, day);
            return (
              <div class={`day ${dayClass}`} title={dayLabel}>
                <span class="day-number">{day}</span>
              </div>
            );
          })}
        </div>
      </div>
    ))}
  </div>
</div>

<div class="max-w-2xl mx-auto mt-12 p-6 bg-white rounded-lg shadow-md">
  <h2 class="text-2xl font-bold text-gray-800 mb-4">Spalvų reikšmės</h2>
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <div class="flex items-center">
      <div class="w-6 h-6 bg-gray-100 border border-gray-200 mr-2"></div>
      <span class="text-sm">Savaitgalis</span>
    </div>
    <div class="flex items-center">
      <div class="w-6 h-6 bg-red-100 border border-gray-200 mr-2"></div>
      <span class="text-sm">Šventinė diena</span>
    </div>
    <div class="flex items-center">
      <div class="w-6 h-6 bg-green-100 border border-gray-200 mr-2"></div>
      <span class="text-sm">Pratęstas savaitgalis (4+ dienos)</span>
    </div>
    <div class="flex items-center">
      <div class="w-6 h-6 bg-blue-100 border border-gray-200 mr-2"></div>
      <span class="text-sm">Ypač pratęstas savaitgalis (5+ dienos)</span>
    </div>
  </div>
</div>
